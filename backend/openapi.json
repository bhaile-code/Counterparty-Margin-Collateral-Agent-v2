{"openapi":"3.1.0","info":{"title":"Margin Collateral Agent","description":"AI-powered agent for OTC derivatives collateral management under ISDA/CSA agreements","version":"0.1.0"},"paths":{"/":{"get":{"summary":"Root","description":"Root endpoint.","operationId":"root__get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/health":{"get":{"summary":"Health Check","description":"Health check endpoint.","operationId":"health_check_health_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/api/v1/documents/upload":{"post":{"tags":["documents"],"summary":"Upload Document","description":"Upload a CSA PDF document.\n\nThe document is saved to the data/pdfs directory for processing.","operationId":"upload_document_api_v1_documents_upload_post","requestBody":{"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_upload_document_api_v1_documents_upload_post"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DocumentUploadResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/parse/{document_id}":{"post":{"tags":["documents"],"summary":"Parse Document","description":"Parse a previously uploaded document using LandingAI ADE (Step 1).\n\nThe parsed document is saved to data/parsed for later extraction.","operationId":"parse_document_api_v1_documents_parse__document_id__post","parameters":[{"name":"document_id","in":"path","required":true,"schema":{"type":"string","title":"Document Id"}},{"name":"save_parsed","in":"query","required":false,"schema":{"type":"boolean","description":"Save parsed result to disk","default":true,"title":"Save Parsed"},"description":"Save parsed result to disk"}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DocumentParseResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/extract/{parse_id}":{"post":{"tags":["documents"],"summary":"Extract Fields","description":"Extract CSA terms from a parsed document using LandingAI ADE (Step 2).\n\nThe extraction result is saved to data/extractions for later use.","operationId":"extract_fields_api_v1_documents_extract__parse_id__post","parameters":[{"name":"parse_id","in":"path","required":true,"schema":{"type":"string","title":"Parse Id"}},{"name":"save_extraction","in":"query","required":false,"schema":{"type":"boolean","description":"Save extraction result to disk","default":true,"title":"Save Extraction"},"description":"Save extraction result to disk"}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/extractions/{extraction_id}":{"get":{"tags":["documents"],"summary":"Get Extraction","description":"Retrieve a previously saved extraction result.\n\nThis allows testing with saved extractions without re-running ADE.","operationId":"get_extraction_api_v1_documents_extractions__extraction_id__get","parameters":[{"name":"extraction_id","in":"path","required":true,"schema":{"type":"string","title":"Extraction Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/normalize/{extraction_id}":{"post":{"tags":["documents"],"summary":"Normalize Collateral","description":"Normalize collateral table from an extraction using AI.\n\nThis endpoint uses Claude API to parse complex maturity buckets and\nstandardize collateral types from the ADE extraction output.","operationId":"normalize_collateral_api_v1_documents_normalize__extraction_id__post","parameters":[{"name":"extraction_id","in":"path","required":true,"schema":{"type":"string","title":"Extraction Id"}},{"name":"save_normalized","in":"query","required":false,"schema":{"type":"boolean","description":"Save normalized result to disk","default":true,"title":"Save Normalized"},"description":"Save normalized result to disk"}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/normalized/{document_id}":{"get":{"tags":["documents"],"summary":"Get Normalized Collateral","description":"Retrieve a previously saved normalized collateral table.\n\nThis allows using normalized data without re-running the AI normalization.","operationId":"get_normalized_collateral_api_v1_documents_normalized__document_id__get","parameters":[{"name":"document_id","in":"path","required":true,"schema":{"type":"string","title":"Document Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/map/{document_id}":{"post":{"tags":["documents"],"summary":"Map To Csa Terms Endpoint","description":"Map extraction and normalized collateral to CSATerms.\n\nIMPORTANT: This endpoint requires that normalization has been completed first.\nIt will fail if normalized collateral doesn't exist for the document.\n\nWorkflow:\n1. Load extraction for document_id\n2. Load normalized collateral for document_id (REQUIRED)\n3. Map to CSATerms using ADEMapper\n4. Save CSATerms (optional)\n5. Return CSATerms summary\n\nArgs:\n    document_id: Document identifier\n    save_csa_terms: Whether to save CSATerms to disk (default: True)\n\nReturns:\n    CSATerms summary with collateral information\n\nRaises:\n    HTTP 400: If normalized collateral doesn't exist (normalization required)\n    HTTP 404: If extraction not found\n    HTTP 500: If mapping fails","operationId":"map_to_csa_terms_endpoint_api_v1_documents_map__document_id__post","parameters":[{"name":"document_id","in":"path","required":true,"schema":{"type":"string","title":"Document Id"}},{"name":"save_csa_terms","in":"query","required":false,"schema":{"type":"boolean","description":"Save CSATerms to disk","default":true,"title":"Save Csa Terms"},"description":"Save CSATerms to disk"}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/csa-terms/{document_id}":{"get":{"tags":["documents"],"summary":"Get Csa Terms","description":"Retrieve saved CSATerms for a document.\n\nReturns the complete CSATerms object with normalized collateral data.","operationId":"get_csa_terms_api_v1_documents_csa_terms__document_id__get","parameters":[{"name":"document_id","in":"path","required":true,"schema":{"type":"string","title":"Document Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/parses/{parse_id}":{"get":{"tags":["documents"],"summary":"Get Parse","description":"Retrieve a previously saved parse result.","operationId":"get_parse_api_v1_documents_parses__parse_id__get","parameters":[{"name":"parse_id","in":"path","required":true,"schema":{"type":"string","title":"Parse Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/documents/list":{"get":{"tags":["documents"],"summary":"List Documents","description":"List all uploaded documents.","operationId":"list_documents_api_v1_documents_list_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/api/v1/documents/{document_id}":{"delete":{"tags":["documents"],"summary":"Delete Document","description":"Delete a document and all associated parsed/extracted data.","operationId":"delete_document_api_v1_documents__document_id__delete","parameters":[{"name":"document_id","in":"path","required":true,"schema":{"type":"string","title":"Document Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/calculations/calculate":{"post":{"tags":["calculations"],"summary":"Calculate Margin","description":"Calculate margin requirement based on CSA terms.\n\nThis endpoint:\n1. Loads CSA terms for the specified document\n2. Runs the margin calculation\n3. Saves the calculation result\n4. Returns the margin call details\n\nNote: This is a simplified implementation for Phase 5 testing.\nFull implementation will be in Phase 6.","operationId":"calculate_margin_api_v1_calculations_calculate_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/CalculateMarginRequest"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CalculationResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/calculations/{calculation_id}/explain":{"post":{"tags":["calculations"],"summary":"Generate Explanation","description":"Generate LLM-powered explanation for a margin calculation.\n\nThis endpoint:\n1. Loads the calculation result\n2. Loads the CSA terms\n3. Generates a comprehensive explanation with citations\n4. Saves the explanation\n5. Returns the explanation\n\nThe explanation includes:\n- Narrative summary with CSA clause citations\n- Step-by-step calculation breakdown\n- Key factors that influenced the result\n- Audit trail\n- Risk assessment\n- Recommended next steps","operationId":"generate_explanation_api_v1_calculations__calculation_id__explain_post","parameters":[{"name":"calculation_id","in":"path","required":true,"schema":{"type":"string","title":"Calculation Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ExplanationResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/calculations/{calculation_id}":{"get":{"tags":["calculations"],"summary":"Get Calculation","description":"Retrieve a previously calculated margin result.\n\nReturns the full calculation details including all steps.","operationId":"get_calculation_api_v1_calculations__calculation_id__get","parameters":[{"name":"calculation_id","in":"path","required":true,"schema":{"type":"string","title":"Calculation Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CalculationResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/calculations/{calculation_id}/explanation":{"get":{"tags":["calculations"],"summary":"Get Explanation","description":"Retrieve a previously generated explanation.\n\nReturns the full explanation with all citations and breakdowns.","operationId":"get_explanation_api_v1_calculations__calculation_id__explanation_get","parameters":[{"name":"calculation_id","in":"path","required":true,"schema":{"type":"string","title":"Calculation Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/calculations/":{"get":{"tags":["calculations"],"summary":"List Calculations","description":"List all calculations.\n\nReturns a list of all calculation IDs.","operationId":"list_calculations_api_v1_calculations__get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}}},"components":{"schemas":{"AuditTrailEvent":{"properties":{"timestamp":{"type":"string","title":"Timestamp","description":"ISO 8601 timestamp"},"event":{"type":"string","title":"Event","description":"Event description"},"details":{"type":"string","title":"Details","description":"Additional context"}},"type":"object","required":["timestamp","event","details"],"title":"AuditTrailEvent","description":"Single event in the audit trail."},"Body_upload_document_api_v1_documents_upload_post":{"properties":{"file":{"type":"string","format":"binary","title":"File"}},"type":"object","required":["file"],"title":"Body_upload_document_api_v1_documents_upload_post"},"CalculateMarginRequest":{"properties":{"document_id":{"type":"string","title":"Document Id","description":"CSA document ID"},"net_exposure":{"type":"number","title":"Net Exposure","description":"Net exposure amount"},"posted_collateral":{"items":{"$ref":"#/components/schemas/CollateralItem"},"type":"array","title":"Posted Collateral","description":"List of posted collateral items"}},"type":"object","required":["document_id","net_exposure"],"title":"CalculateMarginRequest","description":"Request to calculate margin requirement."},"CalculationBreakdownStep":{"properties":{"step_number":{"type":"integer","title":"Step Number"},"step_name":{"type":"string","title":"Step Name"},"explanation":{"type":"string","title":"Explanation","description":"Clear explanation of what this step does and why"},"csa_clause_reference":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Csa Clause Reference","description":"CSA clause reference (e.g., 'Section 3(a)')"},"source_page":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Source Page","description":"Source document page number"},"calculation":{"type":"string","title":"Calculation","description":"Formula with actual values"},"result":{"type":"string","title":"Result","description":"Result with interpretation"}},"type":"object","required":["step_number","step_name","explanation","calculation","result"],"title":"CalculationBreakdownStep","description":"Detailed breakdown of a single calculation step with citations."},"CalculationResponse":{"properties":{"calculation_id":{"type":"string","title":"Calculation Id"},"document_id":{"type":"string","title":"Document Id"},"margin_call":{"$ref":"#/components/schemas/MarginCall"},"status":{"type":"string","title":"Status","default":"calculated"},"calculated_at":{"type":"string","format":"date-time","title":"Calculated At"}},"type":"object","required":["calculation_id","document_id","margin_call"],"title":"CalculationResponse","description":"Response after calculating margin."},"CalculationStep":{"properties":{"step_number":{"type":"integer","title":"Step Number"},"description":{"type":"string","title":"Description"},"formula":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Formula"},"inputs":{"type":"object","title":"Inputs"},"result":{"type":"number","title":"Result"},"source_clause":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Source Clause","description":"Reference to CSA clause that defines this step"}},"type":"object","required":["step_number","description","inputs","result"],"title":"CalculationStep","description":"Represents a single step in the margin calculation."},"CollateralItem":{"properties":{"collateral_type":{"$ref":"#/components/schemas/CollateralType"},"market_value":{"type":"number","exclusiveMinimum":0.0,"title":"Market Value","description":"Current market value in base currency"},"haircut_rate":{"type":"number","maximum":1.0,"minimum":0.0,"title":"Haircut Rate","description":"Haircut rate (0-1, e.g., 0.02 for 2%)"},"currency":{"$ref":"#/components/schemas/Currency","default":"USD"},"description":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Description"},"maturity_date":{"anyOf":[{"type":"string","format":"date-time"},{"type":"null"}],"title":"Maturity Date","description":"Maturity date of the security (for bonds, securities)"},"maturity_years":{"anyOf":[{"type":"number"},{"type":"null"}],"title":"Maturity Years","description":"Maturity in years from valuation date (calculated or provided)"}},"type":"object","required":["collateral_type","market_value","haircut_rate"],"title":"CollateralItem","description":"Represents a piece of posted collateral."},"CollateralType":{"type":"string","enum":["CASH","US_TREASURY","GOVERNMENT_BONDS","CORPORATE_BONDS"],"title":"CollateralType","description":"Types of eligible collateral."},"Currency":{"type":"string","enum":["USD"],"const":"USD","title":"Currency","description":"Supported currencies (MVP: USD only)."},"DocumentParseResponse":{"properties":{"document_id":{"type":"string","title":"Document Id"},"parse_id":{"type":"string","title":"Parse Id"},"status":{"type":"string","title":"Status"},"page_count":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Page Count"},"parsed_at":{"type":"string","format":"date-time","title":"Parsed At"}},"type":"object","required":["document_id","parse_id","status"],"title":"DocumentParseResponse","description":"Response after parsing a document with ADE."},"DocumentUploadResponse":{"properties":{"document_id":{"type":"string","title":"Document Id"},"filename":{"type":"string","title":"Filename"},"file_size":{"type":"integer","title":"File Size"},"upload_timestamp":{"type":"string","format":"date-time","title":"Upload Timestamp"},"status":{"type":"string","title":"Status","default":"uploaded"}},"type":"object","required":["document_id","filename","file_size"],"title":"DocumentUploadResponse","description":"Response after uploading a CSA document."},"ExplanationResponse":{"properties":{"status":{"type":"string","title":"Status","default":"success"},"explanation":{"$ref":"#/components/schemas/MarginCallExplanation"},"message":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Message"}},"type":"object","required":["explanation"],"title":"ExplanationResponse","description":"API response for explanation generation."},"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"MarginCall":{"properties":{"action":{"$ref":"#/components/schemas/MarginCallAction"},"amount":{"type":"number","minimum":0.0,"title":"Amount","description":"Amount to call or return"},"currency":{"$ref":"#/components/schemas/Currency","default":"USD"},"calculation_date":{"type":"string","format":"date-time","title":"Calculation Date"},"net_exposure":{"type":"number","title":"Net Exposure"},"threshold":{"type":"number","title":"Threshold"},"posted_collateral_items":{"items":{"$ref":"#/components/schemas/CollateralItem"},"type":"array","title":"Posted Collateral Items"},"effective_collateral":{"type":"number","title":"Effective Collateral"},"exposure_above_threshold":{"type":"number","title":"Exposure Above Threshold"},"calculation_steps":{"items":{"$ref":"#/components/schemas/CalculationStep"},"type":"array","title":"Calculation Steps"},"csa_terms_id":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Csa Terms Id"},"counterparty_name":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Counterparty Name"}},"type":"object","required":["action","amount","net_exposure","threshold","posted_collateral_items","effective_collateral","exposure_above_threshold"],"title":"MarginCall","description":"Result of a margin calculation."},"MarginCallAction":{"type":"string","enum":["NO_ACTION","CALL","RETURN"],"title":"MarginCallAction","description":"Possible margin call actions."},"MarginCallExplanation":{"properties":{"narrative":{"type":"string","title":"Narrative","description":"Comprehensive 3-5 paragraph explanation with citations"},"key_factors":{"items":{"type":"string"},"type":"array","title":"Key Factors","description":"3-5 key factors that drove this calculation result"},"calculation_breakdown":{"items":{"$ref":"#/components/schemas/CalculationBreakdownStep"},"type":"array","title":"Calculation Breakdown","description":"Step-by-step calculation analysis with citations"},"audit_trail":{"items":{"$ref":"#/components/schemas/AuditTrailEvent"},"type":"array","title":"Audit Trail","description":"Chronological event log with timestamps"},"citations":{"additionalProperties":{"anyOf":[{"type":"integer"},{"type":"null"}]},"type":"object","title":"Citations","description":"Mapping of CSA clauses to page numbers (None if page unknown)"},"risk_assessment":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Risk Assessment","description":"Assessment of collateral position and risks"},"next_steps":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Next Steps","description":"Recommended next actions for operations"},"generated_at":{"type":"string","title":"Generated At","description":"ISO 8601 timestamp when generated"},"llm_model":{"type":"string","title":"Llm Model","description":"LLM model used for generation"},"document_id":{"type":"string","title":"Document Id","description":"Source CSA document ID"},"margin_call_action":{"type":"string","title":"Margin Call Action","description":"Margin call action (CALL/RETURN/NO_ACTION)"},"margin_call_amount":{"type":"number","minimum":0.0,"title":"Margin Call Amount","description":"Margin call amount"},"counterparty_name":{"type":"string","title":"Counterparty Name","description":"Counterparty name"}},"type":"object","required":["narrative","generated_at","llm_model","document_id","margin_call_action","margin_call_amount","counterparty_name"],"title":"MarginCallExplanation","description":"LLM-generated explanation of a margin call with citations."},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"}}}}